name: Build ShockEmu (MacOS)

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout do código
      uses: actions/checkout@v3

    - name: Tornar o script executável e Rodar
      run: |
        # Dá permissão de execução para o script oficial
        chmod +x build.sh
        
        # Executa o script de build oficial do repositório
        ./build.sh
        
        # Caso o build.sh não crie a pasta bin, criamos para garantir
        mkdir -p bin
        
        # Se o build.sh falhar ou não gerar o que esperamos,
        # tentamos compilar manualmente o arquivo correto (iohid_wrap.m)
        if [ ! -f "iohid_wrap.dylib" ] && [ ! -f "bin/iohid_wrap.dylib" ]; then
            echo "Build script não gerou o arquivo. Tentando manual..."
            clang -framework IOKit -framework Foundation -dynamiclib iohid_wrap.m -o bin/iohid_wrap.dylib
        else
            echo "Build parece ter funcionado!"
            # Move para bin se estiver na raiz, para facilitar o upload
            [ -f "iohid_wrap.dylib" ] && mv iohid_wrap.dylib bin/
        fi

    - name: Listar arquivos gerados (Debug)
      run: ls -R bin/

    - name: Upload do Artefato
      uses: actions/upload-artifact@v4
      with:
        name: ShockEmu-MacOS-Binary
        path: bin/
